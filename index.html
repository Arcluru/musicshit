<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neon Vault v3.1 // Audio</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Syncopate:wght@700&family=Outfit:wght@300;400;600&display=swap');

        :root {
            --bg: #050508;
            --accent-1: #ff007a;
            --accent-2: #bc13fe;
            --accent-3: #00d4ff;
            --card-glass: rgba(15, 15, 25, 0.7);
        }

        body {
            background-color: var(--bg);
            background-image: 
                radial-gradient(at 0% 0%, rgba(255, 0, 122, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(0, 212, 255, 0.15) 0px, transparent 50%),
                radial-gradient(at 50% 50%, rgba(188, 19, 254, 0.05) 0px, transparent 50%);
            color: #fff;
            font-family: 'Outfit', sans-serif;
            margin: 0;
            padding: 40px 20px 120px 20px;
            overflow-x: hidden;
        }

        .container { max-width: 1300px; margin: 0 auto; }

        h1 {
            font-family: 'Syncopate', sans-serif;
            text-align: center;
            font-size: clamp(2rem, 8vw, 4rem);
            letter-spacing: 15px;
            margin-bottom: 50px;
            background: linear-gradient(90deg, var(--accent-1), var(--accent-2), var(--accent-3));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 15px rgba(188, 19, 254, 0.5));
            animation: titleGlow 4s infinite alternate;
        }

        @keyframes titleGlow {
            from { filter: drop-shadow(0 0 10px rgba(188, 19, 254, 0.4)); }
            to { filter: drop-shadow(0 0 25px rgba(0, 212, 255, 0.6)); }
        }

        .header-ui {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            padding: 30px;
            border-radius: 30px;
            margin-bottom: 60px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            position: sticky;
            top: 20px;
            z-index: 900;
        }

        #searchInput {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 18px 25px;
            border-radius: 15px;
            color: white;
            font-size: 1.1rem;
            margin-bottom: 20px;
            outline: none;
            transition: 0.4s;
            box-sizing: border-box;
        }

        #searchInput:focus {
            border-color: var(--accent-3);
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.2);
        }

        .controls { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }

        .filter-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #aaa;
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-family: 'Syncopate', sans-serif;
            font-size: 10px;
            transition: 0.3s;
        }

        .filter-btn:hover, .filter-btn.active {
            background: white;
            color: black;
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(255,255,255,0.1);
        }

        .song-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 30px;
        }

        .song-card {
            background: var(--card-glass);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 24px;
            padding: 30px;
            position: relative;
            transition: 0.3s;
            cursor: pointer;
        }

        .song-card-wrapper {
            position: relative;
            perspective: 1000px;
        }

        .song-card-content {
            position: relative;
            z-index: 2;
            pointer-events: none;
        }

        .shatter-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .shard {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--card-glass);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 24px;
            transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            opacity: 0;
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.6), 
                        0 0 25px rgba(188, 19, 254, 0.4),
                        inset 0 0 20px rgba(255, 255, 255, 0.1);
        }

        .song-card-wrapper.shattered .shard { opacity: 1; }
        .song-card-wrapper.shattered .song-card { opacity: 0; }

        .song-card h3 {
            margin: 0 0 15px 0;
            font-size: 1.4rem;
            background: linear-gradient(to right, #fff, #888);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .tag-row { display: flex; gap: 8px; flex-wrap: wrap; }

        .tag {
            font-size: 10px;
            font-weight: 700;
            padding: 6px 14px;
            border-radius: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
            border: 1px solid transparent;
        }

        .tag-nc { background: rgba(188, 19, 254, 0.1); border-color: var(--accent-2); color: #e0aaff; }
        .tag-g { background: rgba(255, 0, 122, 0.1); border-color: var(--accent-1); color: #ff85a1; }
        .tag-m { background: rgba(0, 212, 255, 0.1); border-color: var(--accent-3); color: #90e0ef; }
        .tag-fav { background: linear-gradient(45deg, var(--accent-1), var(--accent-2)); color: white; border: none; }

        /* ====================
           MINI BOTTOM BAR
           ==================== */
        #miniPlayer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(10, 10, 20, 0.95);
            backdrop-filter: blur(15px);
            border-top: 1px solid rgba(255, 255, 255, 0.15);
            z-index: 1900;
            padding: 15px 30px;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transform: translateY(100%);
            transition: transform 0.3s ease-in-out;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
        }

        #miniPlayer.visible { transform: translateY(0); }

        .mini-info { display: flex; align-items: center; gap: 20px; }

        .playing-indicator { display: flex; gap: 3px; height: 15px; align-items: flex-end; }
        .bar { width: 3px; height: 2px; background: var(--accent-3); transition: height 0.1s ease; }

        .playing-indicator.animating .bar { animation: equalizer 0.5s infinite alternate; }
        .playing-indicator.animating .bar:nth-child(2) { animation-delay: 0.1s; background: var(--accent-2); }
        .playing-indicator.animating .bar:nth-child(3) { animation-delay: 0.2s; background: var(--accent-1); }

        @keyframes equalizer { 0% { height: 2px; } 100% { height: 15px; } }

        .mini-title { font-family: 'Outfit', sans-serif; font-weight: 600; font-size: 1.1rem; color: white; }

        .mini-controls { display: flex; gap: 15px; align-items: center; }

        .icon-btn {
            background: none;
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
            font-size: 1.2rem;
        }

        .icon-btn:hover { background: white; color: black; }
        
        .icon-btn.active-btn {
            background: var(--accent-2);
            border-color: var(--accent-2);
            color: white;
            box-shadow: 0 0 10px var(--accent-2);
        }
    </style>
</head>
<body>

<div class="container">
    <h1>THE VAULT</h1>

    <div class="header-ui">
        <input type="text" id="searchInput" placeholder="SEARCH TRACKS..." onkeyup="runFilter()">
        <div class="controls">
            <button class="filter-btn active" data-filter="all" onclick="setCategory('all')">ALL</button>
            <button class="filter-btn" data-filter="fav" onclick="setCategory('fav')">FAVORITES</button>
            <button class="filter-btn" data-filter="nc" onclick="setCategory('nc')">NIGHTCORE</button>
            <button class="filter-btn" data-filter="g" onclick="setCategory('g')">VOICE: G</button>
            <button class="filter-btn" data-filter="m" onclick="setCategory('m')">VOICE: M</button>
        </div>
    </div>

    <div class="song-grid" id="songGrid"></div>
</div>

<div id="miniPlayer">
    <div class="mini-info">
        <div class="playing-indicator" id="equalizer">
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
        </div>
        <div class="mini-title" id="miniTitle">Select a track...</div>
    </div>
    <div class="mini-controls">
        <button class="icon-btn" onclick="toggleLoop()" id="loopBtn" title="Loop Song">üîÅ</button>
        <button class="icon-btn" onclick="playShuffle()" title="Shuffle">üîÄ</button>
        <button class="icon-btn" onclick="togglePlay()"><span id="playIcon">‚ñ∂</span></button>
        <button class="icon-btn" onclick="playNext()" title="Next Song">‚è≠</button>
    </div>
</div>

<script>
    const songs = [
        { title: "Rockefeller Street", tags: ["nc", "g", "fav"], file: "Nightcore_-_Rockefeller_Street_.mp3" },
        { title: "I Got No Time", tags: ["m", "nc"], file: "Five_Nights_at_Freddys_4_Song_-_I_Got_No_Time_FNAF4_-_The_Living_Tombstone_.mp3" },
        { title: "Never Be Alone", tags: ["g", "nc"], file: "Never_Be_Alone_FNAF4_Song_-_Shadrow_.mp3" },
        { title: "Rasputin", tags: ["m"], file: "Boney_M._-_Rasputin_Sopot_Festival_1979_.mp3" },
        { title: "I Can't Decide", tags: ["m"], file: "I_Cant_Decide_.mp3" },
        { title: "It's Been So Long", tags: ["m", "nc"], file: "Its_Been_So_Long_.mp3" },
        { title: "Eye of the Tiger", tags: ["m"], file: "Survivor_-_Eye_Of_The_Tiger_Official_HD_Video_.mp3" },
        { title: "Pretty Scene Girl", tags: ["g"], file: "Pretty_Scene_Girl_.mp3" },
        { title: "Kiss Me Again", tags: ["g"], file: "KISS_ME_AGAIN___.mp3" },
        { title: "Bad Boy", tags: ["nc", "m"], file: "Nightcore_-_Bad_boy_.mp3" },
        { title: "Just Dance", tags: ["nc", "g"], file: "Nightcore_-_Just_Dance_.mp3" },
        { title: "Lucky Lucky", tags: ["g", "nc"], file: "Im_So_Lucky_Lucky_-_Nightcore_.mp3" },
        { title: "Faster N Harder", tags: ["nc", "g"], file: "6arelyhuman_-_Faster_N_Harder_Official_Audio_.mp3" },
        { title: "Crucified", tags: ["g"], file: "Army_Of_Lovers_-_Crucified_Lyrics_.mp3" },
        { title: "Shinitai-chan", tags: ["g"], file: "Shinitai-chan_English_CoverJubyPhonic.mp3" },
        { title: "Judas", tags: ["g"], file: "Judas_-_Lady_GagaBest_part_Lyrics_.mp3" },
        { title: "Sweet Dreams", tags: ["g", "nc"], file: "Eurythmics_-_Sweet_Dreams_Lyrics_.mp3" },
        { title: "How Do You Do", tags: ["nc", "g"], file: "Nightcore_-_How_Do_You_Do_.mp3" },
        { title: "Caramelldansen", tags: ["nc", "g"], file: "Caramella_Girls_-_Caramelldansen_Official_English_Version_.mp3" },
        { title: "Every Time We Touch", tags: ["nc", "g"], file: "Nightcore_-_Everytime_We_Touch_Remix__.mp3" },
        { title: "God is a Girl", tags: ["nc", "g"], file: "Nightcore_-_God_Is_A_Girl_.mp3" },
        { title: "Doktorspiele", tags: ["g", "nc"], file: "Nightcore_-_Doktorspiele_English_.mp3" },
        { title: "Doktorspiele (Original)", tags: ["g"], file: "Doktorspiele_English_Version_.mp3" },
        { title: "When You Leave", tags: ["nc", "m"], file: "Nightcore_-_When_You_Leave_Numa_Numa_.mp3" },
        { title: "Pretty Little Psycho", tags: ["nc", "g"], file: "Nightcore_-_Pretty_Little_Psycho_.mp3" },
        { title: "Sweet Little Bumblebee", tags: ["nc", "g"], file: "Nightcore__Sweet_Little_Bumblebee_lyric_video_.mp3" },
        { title: "Pretty Rave Girl", tags: ["nc", "g"], file: "Pretty_Rave_Girl_2010_-_S3RL_.mp3" },
        { title: "Stereo Love", tags: ["nc"], file: "Stereo_Lovers_-_Stereo_Love_Tiktok_Sped_Up_Version_.mp3" },
        { title: "I'm Good (Blue)", tags: ["g", "nc"], file: "Nightcore__Im_Good_Blue_.mp3" },
        { title: "Naughty Naughty", tags: ["g", "nc"], file: "Nightcore_-_Naughty_Naughty_-_Lyrics_.mp3" },
        { title: "Right Round", tags: ["nc"], file: "Nightcore_Right_Round_.mp3" },
        { title: "How To Be A Heartbreaker", tags: ["g"], file: "Nightcore_-_How_To_Be_A_Heartbreaker_.mp3" },
        { title: "Monster", tags: ["m", "nc"], file: "Nightcore_-_Monster_Skillet_.mp3" },
        { title: "Angel With A Shotgun", tags: ["m", "nc"], file: "Nightcore_-_Angel_With_A_Shotgun_.mp3" },
        { title: "My Heart Beats Like A Drum", tags: ["nc", "g"], file: "Nightcore_-_My_Heart_Beats_Like_A_Drum_.mp3" },
        { title: "Cherry Gum", tags: ["g"], file: "Nightcore_-_Cherry_Gum_Lyrics_.mp3" },
        { title: "I Like The Way You Kiss Me", tags: ["m"], file: "Nightcore_-_i_like_the_way_you_kiss_me_Lyrics_.mp3" },
        { title: "Waiting For Love", tags: ["m", "nc"], file: "Nightcore_-_Waiting_For_Love_.mp3" },
        { title: "Butterfly", tags: ["nc", "g"], file: "Nightcore_-_Butterfly_Lyrics_.mp3" },
        { title: "Solo", tags: ["nc", "g"], file: "Nightcore_-_Solo_-_Lyrics_.mp3" },
        { title: "Discord", tags: ["m", "nc"], file: "Discord_.mp3" },
        { title: "Around The World", tags: ["g", "nc"], file: "Nightcore__Around_the_world_.mp3" },
        { title: "Bad Apple", tags: ["g", "nc"], file: "Bad_Apple_English_CoverJubyPhonic_.mp3" },
        { title: "18", tags: ["g"], file: "Nightcore_-_18_English_.mp3" },
        { title: "Wrap Me In Plastic", tags: ["g", "nc"], file: "Nightcore_-_Wrap_Me_In_Plastic_Lyrics_.mp3" },
        { title: "Bubblegum Bitch", tags: ["g"], file: "Nightcore_-_Bubblegum_Btch_.mp3" },
        { title: "Ancient Dreams", tags: ["g"], file: "MARINA_-_Ancient_Dreams_In_A_Modern_Land_Official_Visual_.mp3" },
        { title: "My Jealousy", tags: ["g"], file: "MY_JEALOUSY_.mp3" },
        { title: "My Jealousy (Nightcore)", tags: ["g", "nc"], file: "MY_JEALOUSY_Nightcore_.mp3" },
        { title: "Lay All Your Love On Me", tags: ["g"], file: "ABBA_-_Lay_All_Your_Love_On_Me_Official_Lyric_Video_.mp3" },
        { title: "Parade", tags: ["m"], file: "Susumu_Hirasawa_-_Parade_.mp3" },
        { title: "My Life Is A Party", tags: ["m"], file: "ItaloBrothers_-_My_Life_Is_A_Party_Official_Video_HD_.mp3" },
        { title: "Kings & Queens (NC)", tags: ["g", "nc"], file: "Nightcore_-_Kings__Queens_Lyrics_.mp3" },
        { title: "Kings & Queens", tags: ["g"], file: "Ava_Max_-_Kings__Queens_.mp3" },
        { title: "Beautiful Day", tags: ["g"], file: "Dj_Melodie_-_Beautiful_Day_.mp3" },
        { title: "Solo Tu", tags: ["g", "nc"], file: "Highland_-_Solo_Tu_Nightcore_Mix_.mp3" },
        { title: "Friday", tags: ["g"], file: "Riton_x_Nightcrawlers_-_Friday_Dopamine_Re-Edit_Its_Friday_Then_Song_.mp3" },
        { title: "The Labyrinth", tags: ["nc"], file: "Nightcore_-_The_Labyrinth_NIVIRO_-_Lyrics_.mp3" },
        { title: "See How I Circle", tags: ["nc"], file: "Miracle_Musical_-_See_how_I_circle_imaginary_mind_Labyrinth_Sped_Up_Lyrics_.mp3" },
        { title: "Gone For Good", tags: ["nc", "g"], file: "Nightcore_-_Gone_For_Good_Lyrics_.mp3" },
        { title: "Full Moon", tags: ["nc", "g"], file: "Nightcore_-_Full_Moon_Lyrics_.mp3" },
        { title: "Escaping Gravity", tags: ["nc"], file: "Nightcore_-_Escaping_Gravity_TheFatRat__Cecilia_Gault__Lyrics_.mp3" },
        { title: "Devil's Lullaby", tags: ["nc", "g"], file: "Nightcore_-_Devils_Lullaby_Lyrics_.mp3" },
        { title: "Drum Go Dum", tags: ["nc", "g"], file: "Nightcore_-_DRUM_GO_DUM_KDA_Lyrics_.mp3" },
        { title: "Who Is She?", tags: ["m"], file: "I_Monster_-_Who_Is_She_Lyrics_.mp3" },
        { title: "Who Is She (NC)", tags: ["nc"], file: "Nightcore_-_Who_is_She_.mp3" },
        { title: "All I Want Is You", tags: ["m", "nc"], file: "Nightcore_all_i_want_is_you_-_Rebzyyx__Lyrics_.mp3" },
        { title: "6 Little Eggs", tags: ["m"], file: "B3nte_Mike_Emilio_-_6_Little_Eggs_.mp3" },
        { title: "Roses Are Red", tags: ["g", "nc"], file: "Nightcore_Roses_Are_Red_Original_Version_.mp3" },
        { title: "Love For You", tags: ["g"], file: "loveli_lori__ovg_-_love_for_you_Official_Audio_.mp3" },
        { title: "From Paris to Berlin", tags: ["g"], file: "INFERNAL_-_From_Paris_to_Berlin_.mp3" },
        { title: "Love You Like a Love Song", tags: ["g", "nc"], file: "Nightcore_-_Love_You_Like_a_Love_Song_Lyrics_.mp3" },
        { title: "Dam Dadi Do", tags: ["nc"], file: "Nightcore_-_Dam_Dadi_Do_.mp3" },
        { title: "I Love You So", tags: ["g"], file: "Schnuffel-I_love_you_so_.mp3" },
        { title: "Monster (Sped Up)", tags: ["m"], file: "Monster_Sped_Up_.mp3" },
        { title: "Winter 4Ever", tags: ["g", "nc"], file: "Baby_Jane_-_winter_4ever_sped_up_.mp3" },
        { title: "Gold", tags: ["m"], file: "Spandau_Ballet_-_Gold_HD_Remastered_.mp3" },
        { title: "I Really Want to Stay", tags: ["g"], file: "Cyberpunk_Edgerunners__I_Really_Want_to_Stay_At_Your_House_by_Rosa_Walton__Netflix_.mp3" },
        { title: "Hero Rider Jeans", tags: ["m"], file: "Lil_Hero_-_Hero_Rider_Jeans_Lyrics_Dun_dun_dun_.mp3" },
        { title: "Washing Machine Heart", tags: ["g", "nc"], file: "washing_machine_heart_-_mitski_sped_upnightcore_.mp3" },
        { title: "Oh My Little Baby Boy", tags: ["g", "nc"], file: "Nightcore__Oh_My_Little_Baby_Boy_Lyrics_.mp3" },
        { title: "Partners In Crime", tags: ["nc"], file: "Nightcore_-_Partners_In_Crime_.mp3" },
        { title: "I Don't Know", tags: ["nc"], file: "Nightcore_-_I_Dont_Know_.mp3" },
        { title: "Ready or Not", tags: ["g", "nc"], file: "Nightcore_-_Ready_or_not_.mp3" },
        { title: "Cheri Cheri Lady", tags: ["nc"], file: "Nightcore_-_Cheri_Cheri_Lady_.mp3" },
        { title: "The World We Knew", tags: ["m"], file: "The_World_We_Knew_Over_And_Over_.mp3" },
        { title: "My Ordinary Life", tags: ["m"], file: "My_Ordinary_Life_.mp3" },
        { title: "Don't Stop The Music", tags: ["g", "nc"], file: "Nightcore_Dont_Stop_The_Music_-_Rihanna__Lyrics_.mp3" },
        { title: "Angel of Darkness", tags: ["nc"], file: "Nightcore_Angel_of_Darkness_Lyrics_.mp3" },
        { title: "Dark Red", tags: ["nc"], file: "Dark_red_nightcore_.mp3" },
        { title: "House Of Memories", tags: ["nc"], file: "Nightcore_House_Of_Memories_.mp3" },
        { title: "Bass Slut", tags: ["g"], file: "Bass_Slut_-_S3RL_feat._Tamika_.mp3" },
        { title: "Gossip", tags: ["m", "nc"], file: "_Nightcore_-_GOSSIP__Mneskin_Tom_Morello_Lyrics_.mp3" },
        { title: "Lovefool", tags: ["g", "nc"], file: "Nightcore_-_twocolors__Lovefool_ft._Pia_Mia_Lyrics_.mp3" },
        { title: "Paint It Black", tags: ["nc"], file: "Nightcore_-_Paint_It_Black_.mp3" },
        { title: "I'm So Crazy For You", tags: ["m"], file: "Im_so_crazy_for_youuu_3_.mp3" },
        { title: "All I Ever Wanted", tags: ["m"], file: "Basshunter_-_All_I_Ever_Wanted_OFFICIAL_VIDEO_Ultra_Music_.mp3" }
    ];

    let currentCategory = 'all';
    let currentShattered = null;
    let audioPlayer = new Audio();
    audioPlayer.volume = 0.5; // Default volume since slider is removed
    
    // New State Variables
    let currentSongIndex = -1;
    let isLooping = false;

    // Modified startTrack to handle indexing
    function startTrack(index) {
        if(index < 0 || index >= songs.length) return;
        
        currentSongIndex = index;
        const song = songs[index];
        
        audioPlayer.src = "songs/" + song.file;
        audioPlayer.play().catch(e => console.error("Playback failed:", e));
        
        document.getElementById('miniTitle').textContent = song.title;
        document.getElementById('miniPlayer').classList.add('visible');
        updatePlayIcon(true);
    }

    function togglePlay() {
        if (!audioPlayer.src) return;
        audioPlayer.paused ? audioPlayer.play() : audioPlayer.pause();
        updatePlayIcon(!audioPlayer.paused);
    }

    function updatePlayIcon(isPlaying) {
        document.getElementById('playIcon').textContent = isPlaying ? "‚è∏" : "‚ñ∂";
        document.getElementById('equalizer').classList.toggle('animating', isPlaying);
    }

    // --- NEW CONTROLS LOGIC ---

    function playNext() {
        if (songs.length === 0) return;
        // Increment index, wrap around if at end
        let nextIndex = (currentSongIndex + 1) % songs.length;
        startTrack(nextIndex);
    }

    function playShuffle() {
        if (songs.length <= 1) return;
        let r;
        // Ensure we don't pick the same song unless it's the only one
        do {
            r = Math.floor(Math.random() * songs.length);
        } while (r === currentSongIndex);
        
        startTrack(r);
        // Note: Loop state persists. If loop was on, this new random song will now loop.
    }

    function toggleLoop() {
        isLooping = !isLooping;
        const btn = document.getElementById('loopBtn');
        if (isLooping) {
            btn.classList.add('active-btn');
        } else {
            btn.classList.remove('active-btn');
        }
    }

    // --- EVENT LISTENERS ---

    // Handle song end
    audioPlayer.addEventListener('ended', () => {
        if (isLooping) {
            // If looping, replay current
            audioPlayer.currentTime = 0;
            audioPlayer.play();
        } else {
            // Otherwise play next
            playNext();
        }
    });

    // --- VISUAL SHATTER EFFECT ---

    function createShards(wrapper, content, index) {
        const container = document.createElement('div');
        container.className = 'shatter-container';
        const shardData = [
            { clip: 'polygon(0 0, 35% 0, 25% 30%, 0 25%)', transform: 'translate(-8px, -8px) rotate(-3deg)' },
            { clip: 'polygon(35% 0, 65% 0, 55% 25%, 25% 30%)', transform: 'translate(0, -12px) rotate(2deg)' },
            { clip: 'polygon(65% 0, 100% 0, 100% 20%, 75% 28%, 55% 25%)', transform: 'translate(10px, -10px) rotate(-4deg)' },
            { clip: 'polygon(0 25%, 25% 30%, 20% 55%, 0 50%)', transform: 'translate(-12px, 0) rotate(2deg)' },
            { clip: 'polygon(25% 30%, 55% 25%, 60% 45%, 45% 60%, 20% 55%)', transform: 'translate(0, 5px) rotate(-2deg)' },
            { clip: 'polygon(70% 50%, 100% 45%, 100% 70%, 75% 72%)', transform: 'translate(12px, 5px) rotate(2deg)' },
            { clip: 'polygon(0 50%, 20% 55%, 15% 78%, 0 75%)', transform: 'translate(-10px, 8px) rotate(-2deg)' },
            { clip: 'polygon(15% 78%, 40% 85%, 55% 90%, 70% 95%, 100% 100%, 0 100%)', transform: 'translate(0, 18px) rotate(0deg)' }
        ];

        shardData.forEach(s => {
            const piece = document.createElement('div');
            piece.className = 'shard';
            piece.style.clipPath = s.clip;
            piece.innerHTML = content;
            piece.dataset.transform = s.transform;
            container.appendChild(piece);
        });

        wrapper.appendChild(container);
        
        // Grid Click Handler
        wrapper.addEventListener('click', () => {
            if (currentShattered && currentShattered !== wrapper) {
                currentShattered.classList.remove('shattered');
                currentShattered.querySelectorAll('.shard').forEach(s => s.style.transform = 'translate(0,0) rotate(0deg)');
            }
            wrapper.classList.add('shattered');
            wrapper.querySelectorAll('.shard').forEach(s => s.style.transform = s.dataset.transform);
            currentShattered = wrapper;
            
            // Start track via index
            startTrack(index);
        });
    }

    function renderSongs() {
        const grid = document.getElementById('songGrid');
        grid.innerHTML = songs.map((song, i) => `
            <div class="song-card-wrapper" data-title="${song.title.toLowerCase()}" data-tags="${song.tags.join(' ')}">
                <div class="song-card">
                    <div class="song-card-content">
                        <h3>${song.title}</h3>
                        <div class="tag-row">${song.tags.map(t => `<span class="tag tag-${t}">${t === 'nc' ? 'Nightcore' : t.toUpperCase()}</span>`).join('')}</div>
                    </div>
                </div>
            </div>`).join('');

        document.querySelectorAll('.song-card-wrapper').forEach((wrapper, i) => {
            // Pass index to createShards so it knows which song to play
            createShards(wrapper, wrapper.querySelector('.song-card-content').innerHTML, i);
        });
    }

    function setCategory(cat) {
        currentCategory = cat;
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.toggle('active', b.dataset.filter === cat));
        runFilter();
    }

    function runFilter() {
        const query = document.getElementById('searchInput').value.toLowerCase();
        document.querySelectorAll('.song-card-wrapper').forEach(card => {
            const matchesSearch = card.dataset.title.includes(query) || card.dataset.tags.includes(query);
            const matchesCat = currentCategory === 'all' || card.dataset.tags.split(' ').includes(currentCategory);
            card.style.display = (matchesSearch && matchesCat) ? 'block' : 'none';
        });
    }

    renderSongs();
</script>
</body>
</html>
